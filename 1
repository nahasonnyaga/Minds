server {
	listen   443; ## listen for ipv4; this line is default and implied
	listen   [::]:443 default ipv6only=on; ## listen for ipv6

	ssl on;
        ssl_certificate /home/ubuntu/minds14.crt;
        ssl_certificate_key /home/ubuntu/minds14.key;

	add_header Strict-Transport-Security "max-age=0; includeSubdomains;";


	 if ($host = 'minds.com' ) {
              rewrite  ^/(.*)$  https://www.minds.com/$1  permanent;
         }

         if ($host = 'minds.org') {
              rewrite  ^/(.*)$  http://www.minds.org/$1  permanent;
         }

	    location /nginx_status {
        # Turn on stats
        stub_status on;
        access_log   off;
         # only allow access from 192.168.1.5 #
        # allow 192.168.1.5;
        # deny all;
         }

	        location ~ ^/(status|ping)$ {
         access_log off;
    # allow 127.0.0.1;
    # allow 1.2.3.4#your-ip;
    # deny all;
         include fastcgi_params;
           fastcgi_pass php;
        }

	root /var/www/elgg;
	index index.php

	# Make site accessible from http://localhost/
	server_name www.minds.com;

	# Temp fix for large cookies...
	large_client_header_buffers 4 16k; 

	# Basic elgg rewrite rules
	# Cache before everything
	rewrite	^/cache\/(.+)$ /engine/handlers/cache_handler.php?request=$1&$args;
	rewrite /rewrite.php$ /install.php;

	location ~ /\.git{
		deny all;
	}

    #location /api {
    #    add_header 'Access-Control-Allow-Origin' '*';
   # }

	# Cache headers
	location ~* \.(png|jpg|jpeg|gif|ico)$ {
		expires 1y;
		log_not_found off;
	}

	# General rewrite to location @rewrite
	location / {
		try_files $uri $uri/ @rewrite;
		index index.php;
		port_in_redirect off;
		client_max_body_size 10000000M;
		server_tokens off;
	}

	error_page 500 /errors/500.html;
	error_page 502 /errors/502.html;
	error_page 503 504 /errors/503.html;

	# Rewrite rules from elgg community site
	location @rewrite {
		rewrite ^(.+)$ /index.php last;
	 }

		#Cache status

        #Cache everything by default
        set $no_cache 0;

        #Don't cache POST requests
        if ($request_method = POST){
            set $no_cache 1;
        }

        #Don't cache the following URLs
        if ($request_uri ~* "/(administrator/|action/|social/)"){
            set $no_cache 1;
        }

        #Don't cache if there is a cookie called PHPSESSID
        if ($http_cookie ~ "(mindsperm|mindsMessages|mindsStickyForm)" ){
            set $no_cache 1;
        }

        if ( $cookie_loggedin = "1" ) {
            set $no_cache 1;
        }

        if ( $cookie_mindsStickyForm){
             set $no_cache 1;
        }

        add_header X-Cache $upstream_cache_status;
        add_header No-Cache $no_cache;

	# Pass all .php files onto a php-fpm/php-fcgi server.
	location ~ \.php$ {
		fastcgi_cache MINDS;
		# Cache per view
                set $viewtype "default";
        
                if ($no_cache = 0){
                        more_clear_headers "Set-Cookie*";
                        more_clear_headers "Cache-Control*";
                        more_clear_headers "Expires*";
                }

                fastcgi_cache_key "$scheme$request_method$host$request_uri";
                fastcgi_ignore_headers Cache-Control Expires Set-Cookie;

                fastcgi_cache_valid 301 1d;
                fastcgi_cache_valid 404 1m;
                fastcgi_cache_valid any 1m;
                fastcgi_cache_min_uses 2;
                fastcgi_cache_use_stale error timeout invalid_header http_500;

                fastcgi_cache_valid 200 20m;
                fastcgi_cache_bypass $no_cache;
                fastcgi_no_cache $no_cache;

                fastcgi_split_path_info ^(.+\.php)(/.+)$;


 		  fastcgi_connect_timeout 600;
 		   fastcgi_send_timeout 600;
		    fastcgi_read_timeout 600;

		fastcgi_buffers 64 32k;
		fastcgi_buffer_size 64k;
         

 
	      #NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini
                include fastcgi_params;
                fastcgi_index index.php;
                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                fastcgi_param SERVER_NAME $host;
                fastcgi_pass php;
                fastcgi_max_temp_file_size 0;

                try_files $uri =404;
	}

}


